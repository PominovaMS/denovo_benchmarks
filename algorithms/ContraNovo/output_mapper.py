"""
Script to convert predictions from the algorithm output format 
to the common output format.
"""

import argparse
import os
import re
from tqdm import tqdm
from pyteomics import mgf
from pyteomics.mztab import MzTab
from base import OutputMapperBase


class OutputMapper(OutputMapperBase):
    REPLACEMENTS = [
        ("C+57.021", "C[UNIMOD:4]"),
        # Amino acid modifications.
        ("M+15.995", "M[UNIMOD:35]"),    # Met oxidation
        ("N+0.984", "N[UNIMOD:7]"),     # Asn deamidation
        ("Q+0.984", "Q[UNIMOD:7]"),     # Gln deamidation
        # N-terminal modifications.
        ("+42.011", "[UNIMOD:1]"),      # Acetylation
        ("+43.006", "[UNIMOD:5]"),      # Carbamylation
        ("-17.027", "[UNIMOD:385]"),     # NH3 loss
        # "+43.006-17.027": 25.980265      # Carbamylation and NH3 loss
    ]
    N_TERM_MOD_PATTERN = r"^(\[UNIMOD:[0-9]+\])" # find N-term modifications

    def __init__(self, input_dir: str) -> None:
        """TODO."""
        fnames = [fname for fname in os.listdir(input_dir) if fname.endswith(".mgf")]
        self.file_names = [fname.split(".")[0] for fname in sorted(fnames)]

        self.title2spec_idx = {fname: [] for fname in self.file_names}

        for fname in self.file_names:
            print(fname, ": get spectrum indices.")

            filename = os.path.join(input_dir, fname + ".mgf")
            spectra = mgf.read(filename)

            self.title2spec_idx[fname] = {
                spectra[i]["params"]["title"]: i
                for i in tqdm(range(len(spectra)))
            }
        return
    
    def _transform_match_n_term_mod(self, match: re.Match) -> str:
        """
        Transform representation of peptide substring matching
        the N-term modification pattern.
        `[n_mod]PEP` -> `[n_mod]-PEP`
        
        Parameters
        ----------
        match : re.Match
            Substring matching the N-term modification pattern.

        Returns
        -------
        transformed_match : str
            Transformed N-term modification pattern representation.
        """
        ptm = match.group(1)
        return f"{ptm}-"
    
    def _parse_scores(self, scores: str) -> list[float]:
        """
        Convert per-token scores from a string of float scores 
        separated by ',' to a list of float numbers.
        """
        scores = scores.split(",")
        scores = list(map(float, scores))
        return scores

    def format_spectrum_id(self, spectrum_id: str) -> str:
        """
        TODO.
        Transform spectrum id generated by the algorithm to the common format
        `filename.scan.scan.charge` -> `filename:spectrum_idx`.
        """

        spectrum_title = spectrum_id
        filename = spectrum_id.split(".")[0]
        spectrum_idx = self.title2spec_idx[filename][spectrum_title]

        spectrum_id = filename + ":" + str(spectrum_idx)
        return spectrum_id
    
    def format_sequence(self, sequence: str) -> str:
        """
        Convert peptide sequence to the common output data format 
        (ProForma with modifications represented 
        in the delta mass notation).

        Parameters
        ----------
        sequence : str
            Peptide sequence in the original algorithm output format.

        Returns
        -------
        transformed_sequence : str
            Peptide sequence in the common output data format.   
        """

        # direct (token-to-token) replacements
        for repl_args in self.REPLACEMENTS:
            sequence = sequence.replace(*repl_args)

        # transform n-term modification notation
        # represent in ProForma delta mass notation [+n_term_mod]-PEP
        if re.search(self.N_TERM_MOD_PATTERN, sequence):
            sequence = re.sub(self.N_TERM_MOD_PATTERN, self._transform_match_n_term_mod, sequence)

        return sequence


parser = argparse.ArgumentParser()
parser.add_argument(
    "--output_path", required=True, help="The path to the algorithm predictions file."
)
parser.add_argument(
    "--input_dir", required=True, help="The dir with the input dataset .mgf files.",
)
args = parser.parse_args()

# Read predictions from output file
output_data = MzTab(args.output_path)
output_data = output_data.spectrum_match_table

# Rename columns to the expected column names if needed
output_data = output_data.rename(
    {
        "search_engine_score[1]": "score",
        "spectra_ref": "spectrum_id",
        "opt_ms_run[1]_aa_scores": "aa_scores",
    },
    axis=1,
)

# Transform data to the common output format
output_mapper = OutputMapper(input_dir=args.input_dir)
output_data = output_mapper.format_output(output_data)

# Save processed predictions to outputs.csv
# (the expected name for the algorithm output file)
output_data.to_csv("outputs.csv", index=False)
